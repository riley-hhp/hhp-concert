
# 시퀀스 다이어그램

```text
대기열은 사용자의 토큰(번호표 역할)을 생성하고, 
줄을 세워서 입장 순서가 된 사용자를 콘서트 서비스에 접근하게 하는 유량 제어 역할을 담당합니다.
콘서트는 토큰을 가진 사용자의 콘서트 예메 서비스를 제공합니다.
결제 서비스는 유저의 포인트를 이용해서 콘서트 비용을 지불하여 예약을 완료합니다.
```


```mermaid
sequenceDiagram
    
    title 콘서트 예약 시스템 전체 흐름
    actor  사용자
    participant 대기열
    participant 콘서트
    participant 결제

    사용자->>대기열: 대기열 토큰 요청
    대기열-->>사용자: 대기열 토큰 발급
    사용자->>콘서트: 콘서트 목록 요청 (토큰 포함)
    콘서트-->>사용자: 콘서트 목록 반환
    사용자->>콘서트: 특정 콘서트 선택 (토큰 포함)
    콘서트-->>사용자: 선택한 콘서트 정보 반환
    사용자->>콘서트: 좌석 선택 요청 (토큰 포함)
    콘서트-->>사용자: 사용 가능한 좌석 목록 반환
    사용자->>콘서트: 좌석 예약 요청 (토큰 포함)
    콘서트->>결제: 결제 요청
    결제-->>콘서트: 결제 성공 응답
    콘서트-->>사용자: 예약 완료 메시지
``` 


```mermaid
sequenceDiagram
    
    title 대기열
    actor  사용자
    participant 대기열
    participant DB
        
    사용자->>대기열: 1. 사용자 진입 (토큰X, 최초진입)
    대기열->>DB: 토큰 요청 (토큰데이터 저장, DB 순서 채번)
    DB-->>사용자: 토큰 발급
    사용자->>대기열: 2. 사용자 진입 (토큰O)
    loop 대기열 순서 조회
        사용자->>대기열: 내 순서니? (폴링)
        대기열-->>사용자: 기다려 / 들어가
    end
``` 

```mermaid
sequenceDiagram
    
    title 콘서트
    actor  사용자
    participant 콘서트
    participant DB
    alt @CheckToken (AOP)
        콘서트->>DB: 유효성 검사
        DB-->>사용자: 유효하지 않은 토큰일 경우 : 예외 발생
    end
    사용자->>DB: 콘서트 목록 요청 (유효한 토큰 포함)
    DB-->>사용자: 콘서트 목록 반환
    사용자->>DB: 특정 콘서트 선택 (유효한 토큰 포함)
    DB-->>사용자: 선택한 콘서트 정보 반환
    사용자->>DB: 좌석 선택 요청 (유효한 토큰 포함)
    DB-->>사용자: 사용 가능한 좌석 목록 반환
    사용자->>DB: 좌석 예약 요청 (유효한 토큰 포함)
```

```mermaid
sequenceDiagram

    title 결제
    actor  사용자
    participant 콘서트
    participant 결제
    participant DB

    사용자->>콘서트: 좌석 예약 요청 (토큰 포함)
    콘서트->>결제: 결제 요청
    결제->>DB: 포인트 잔액 확인 요청
    DB-->>결제: 포인트 잔액
    alt 5분 초과 or 잔액 < 결제금액 : 실패
        결제-->>사용자: 결제 실패
    end
    alt 5분 이내 and 잔액 > 결제금액 : 성공
        결제->>DB: 잔액 차감
        결제->>DB: 결제 내역 저장
        DB-->>결제: 처리 결과 반환
        결제-->>콘서트: 결제 성공 응답
        콘서트->>콘서트: 좌석 예약 비즈니스 로직
        콘서트-->>사용자: 예약 완료 메시지
    end
``` 

```mermaid
sequenceDiagram
    
    title 좌석예약
    actor  사용자
    participant 예약
    participant DB
    alt @CheckToken (AOP)
        사용자->>DB: 유효성 검사
        DB-->>예약: 유효하지 않은 토큰일 경우 : 예외 발생
    end
    사용자->>예약: 좌석 예약 요청 (유효한 토큰 포함)
    예약->>DB: 좌석 임시 예약(5분)
    alt 5분 이내 결제 완료 시
        예약->>DB: 좌석 예약 완료 저장
        DB-->>사용자: 좌석 예약 완료
    end
    alt 5분 이내 결제 실패 시
        예약->>DB: 좌석 오픈 (다시 예매가능 상태로)
        DB-->>사용자: 좌석 예약 실패
    end
```


```mermaid
sequenceDiagram

    title 잔액 충전/조회
    actor  사용자
    participant 포인트
    participant DB

    사용자->>DB: 포인트 조회 요청
    DB-->>사용자: 포인트 잔액
    사용자->>포인트: 포인트 충전 요청
    포인트->>DB: 포인트 충전
    DB-->>사용자: 포인트 잔액
``` 